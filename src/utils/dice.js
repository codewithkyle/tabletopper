/**
 * @dice-roller/rpg-dice-roller - An advanced JS based dice roller that can roll various types of dice and modifiers, along with mathematical equations.
 * 
 * @version 5.2.1
 * @license MIT
 * @author GreenImp Media <info@greenimp.co.uk> (http://greenimp.co.uk)
 * @link https://dice-roller.github.io/documentation
 */

import{evaluate as t}from"mathjs";class CompareOperatorError extends TypeError{constructor(t){super(`Operator "${t}" is invalid`),TypeError.captureStackTrace&&TypeError.captureStackTrace(this,CompareOperatorError),this.name="CompareOperatorError",this.operator=t}}class DataFormatError extends Error{constructor(t){super(`Invalid data format: ${t}`),Error.captureStackTrace&&Error.captureStackTrace(this,DataFormatError),this.name="ImportError",this.data=t}}class DieActionValueError extends Error{constructor(t,e=null){super(`Die "${t}" must have more than 1 possible value to ${e||"do this action"}`),Error.captureStackTrace&&Error.captureStackTrace(this,DieActionValueError),this.name="DieActionValueError",this.action=e,this.die=t}}class NotationError extends Error{constructor(t){super(`Notation "${t}" is invalid`),Error.captureStackTrace&&Error.captureStackTrace(this,NotationError),this.name="NotationError",this.notation=t}}class RequiredArgumentError extends Error{constructor(t=null){super("Missing argument"+(t?` "${t}"`:"")),Error.captureStackTrace&&Error.captureStackTrace(this,RequiredArgumentError),this.argumentName=t}}var e=Object.freeze({__proto__:null,CompareOperatorError:CompareOperatorError,DataFormatError:DataFormatError,DieActionValueError:DieActionValueError,NotationError:NotationError,RequiredArgumentError:RequiredArgumentError});const r=e=>t(e),n=t=>("number"==typeof t||"string"==typeof t)&&(!Number.isNaN(t)&&Number.isFinite(Number(t))),i=t=>{if(!n(t))return!1;const e=Number(t);return e<=Number.MAX_SAFE_INTEGER&&e>=Number.MIN_SAFE_INTEGER};function o(t){return 0|t.next()}function s(t,e){return 0===e?t:r=>t(r)+e}function a(t){const e=0|t.next();return 4294967296*(2097151&e)+(t.next()>>>0)+(2097152&e?-9007199254740992:0)}function u(t){for(;;){const e=0|t.next();if(!(4194304&e)){return 4294967296*(2097151&e)+(t.next()>>>0)+(2097152&e?-9007199254740992:0)}if(4194304==(8388607&e)&&0==(0|t.next()))return 9007199254740992}}function l(t){return t.next()>>>0}function c(t){return 4294967296*(2097151&t.next())+(t.next()>>>0)}function h(t){for(;;){const e=0|t.next();if(!(2097152&e)){return 4294967296*(2097151&e)+(t.next()>>>0)}if(0==(2097151&e)&&0==(0|t.next()))return 9007199254740992}}function f(t){return 0==(t+1&t)}function p(t){return f(t)?(e=t,t=>t.next()&e):function(t){const e=t+1,r=e*Math.floor(4294967296/e);return t=>{let n=0;do{n=t.next()>>>0}while(n>=r);return n%e}}(t);var e}function d(t){const e=t+1;if(0==(0|e)){const t=(e/4294967296|0)-1;if(f(t))return r=t,t=>4294967296*(t.next()&r)+(t.next()>>>0)}var r;return function(t){const e=t*Math.floor(9007199254740992/t);return r=>{let n=0;do{n=4294967296*(2097151&r.next())+(r.next()>>>0)}while(n>=e);return n%t}}(e)}function m(t,e){return r=>{let n=0;do{const t=0|r.next();n=4294967296*(2097151&t)+(r.next()>>>0)+(2097152&t?-9007199254740992:0)}while(n<t||n>e);return n}}function g(t,e){if(t=Math.floor(t),e=Math.floor(e),t<-9007199254740992||!isFinite(t))throw new RangeError("Expected min to be at least -9007199254740992");if(e>9007199254740992||!isFinite(e))throw new RangeError("Expected max to be at most 9007199254740992");const r=e-t;return r<=0||!isFinite(r)?()=>t:4294967295===r?0===t?l:s(o,t+2147483648):r<4294967295?s(p(r),t):9007199254740991===r?s(c,t):r<9007199254740991?s(d(r),t):e-1-t==9007199254740991?s(h,t):-9007199254740992===t&&9007199254740992===e?u:-9007199254740992===t&&9007199254740991===e?a:-9007199254740991===t&&9007199254740992===e?s(a,1):9007199254740992===e?s(m(t-1,e-1),1):m(t,e)}function y(t){return 1==(1&t.next())}function w(t,e){return r=>t(r)<e}function b(t,e){return null==e?null==t?y:function(t){if(t<=0)return()=>!1;if(t>=1)return()=>!0;{const e=4294967296*t;return e%1==0?w(o,e-2147483648|0):w(c,Math.round(9007199254740992*t))}}(t):t<=0?()=>!1:t>=e?()=>!0:w(g(0,e-1),t)}function x(t){return g(1,t)}function v(t="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789_-"){const e=t.length;if(!e)throw new Error("Expected pool not to be an empty string");const r=g(0,e-1);return(e,n)=>{let i="";for(let o=0;o<n;++o){const n=r(e);i+=t.charAt(n)}return i}}const E=v("0123456789abcdef"),S=v("0123456789abcdef".toUpperCase());function R(t,e){return t<0?Math.max(t+e,0):Math.min(t,e)}function A(t){const e=+t;return e<0?Math.ceil(e):Math.floor(e)}function M(t){return c(t)/9007199254740992}function T(t){return h(t)/9007199254740992}const C=Array.prototype.slice;function N(t,e,r=0){const n=e.length;if(n)for(let i=n-1>>>0;i>r;--i){const r=g(0,i)(t);if(i!==r){const t=e[i];e[i]=e[r],e[r]=t}}return e}const O=(()=>{try{if("xxx"==="x".repeat(3))return(t,e)=>t.repeat(e)}catch(t){}return(t,e)=>{let r="";for(;e>0;)1&e&&(r+=t),e>>=1,t+=t;return r}})();function $(t,e){return O("0",e-t.length)+t}const D={next:()=>4294967296*Math.random()|0};class Random{constructor(t=D){this.engine=t}int32(){return o(this.engine)}uint32(){return l(this.engine)}uint53(){return c(this.engine)}uint53Full(){return h(this.engine)}int53(){return a(this.engine)}int53Full(){return u(this.engine)}integer(t,e){return g(t,e)(this.engine)}realZeroToOneInclusive(){return T(this.engine)}realZeroToOneExclusive(){return M(this.engine)}real(t,e,r=!1){return function(t,e,r=!1){if(!isFinite(t))throw new RangeError("Expected min to be a finite number");if(!isFinite(e))throw new RangeError("Expected max to be a finite number");return s((n=r?T:M,1==(i=e-t)?n:0===i?()=>0:t=>n(t)*i),t);var n,i}(t,e,r)(this.engine)}bool(t,e){return b(t,e)(this.engine)}pick(t,e,r){return function(t,e,r,n){const i=e.length;if(0===i)throw new RangeError("Cannot pick from an empty array");const o=null==r?0:R(A(r),i),s=void 0===n?i:R(A(n),i);if(o>=s)throw new RangeError(`Cannot pick between bounds ${o} and ${s}`);return e[g(o,s-1)(t)]}(this.engine,t,e,r)}shuffle(t){return N(this.engine,t)}sample(t,e){return function(t,e,r){if(r<0||r>e.length||!isFinite(r))throw new RangeError("Expected sampleSize to be within 0 and the length of the population");if(0===r)return[];const n=C.call(e),i=n.length;if(i===r)return N(t,n,0);const o=i-r;return N(t,n,o-1).slice(o)}(this.engine,t,e)}die(t){return x(t)(this.engine)}dice(t,e){return function(t,e){const r=x(t);return t=>{const n=[];for(let i=0;i<e;++i)n.push(r(t));return n}}(t,e)(this.engine)}uuid4(){return function(t){const e=t.next()>>>0,r=0|t.next(),n=0|t.next(),i=t.next()>>>0;return $(e.toString(16),8)+"-"+$((65535&r).toString(16),4)+"-"+$((r>>4&4095|16384).toString(16),4)+"-"+$((16383&n|32768).toString(16),4)+"-"+$((n>>4&65535).toString(16),4)+$(i.toString(16),8)}(this.engine)}string(t,e){return v(e)(this.engine,t)}hex(t,e){return function(t){return t?S:E}(e)(this.engine,t)}date(t,e){return function(t,e){const r=g(+t,+e);return t=>new Date(r(t))}(t,e)(this.engine)}}const F=(()=>{try{const t=new ArrayBuffer(4),e=new Int32Array(t);if(e[0]=2147483648,-2147483648===e[0])return Int32Array}catch(t){}return Array})();let P=null;let I=128;const J={next:()=>(I>=128&&(null===P&&(P=new F(128)),crypto.getRandomValues(P),I=0),0|P[I++])};const j=(()=>{try{if(-5===Math.imul(4294967295,5))return Math.imul}catch(t){}const t=65535;return(e,r)=>{const n=e&t,i=r&t;return n*i+((e>>>16&t)*i+n*(r>>>16&t)<<16>>>0)|0}})(),q=2567483615;class MersenneTwister19937{constructor(){this.data=new F(624),this.index=0,this.uses=0}static seed(t){return(new MersenneTwister19937).seed(t)}static seedWithArray(t){return(new MersenneTwister19937).seedWithArray(t)}static autoSeed(){return MersenneTwister19937.seedWithArray(function(t=D,e=16){const r=[];r.push(0|(new Date).getTime());for(let n=1;n<e;++n)r[n]=0|t.next();return r}())}next(){(0|this.index)>=624&&(G(this.data),this.index=0);const t=this.data[this.index];return this.index=this.index+1|0,this.uses+=1,0|function(t){return t^=t>>>11,t^=t<<7&2636928640,(t^=t<<15&4022730752)^t>>>18}(t)}getUseCount(){return this.uses}discard(t){if(t<=0)return this;for(this.uses+=t,(0|this.index)>=624&&(G(this.data),this.index=0);t+this.index>624;)t-=624-this.index,G(this.data),this.index=0;return this.index=this.index+t|0,this}seed(t){let e=0;this.data[0]=e=0|t;for(let t=1;t<624;t=t+1|0)this.data[t]=e=j(e^e>>>30,1812433253)+t|0;return this.index=624,this.uses=0,this}seedWithArray(t){return this.seed(19650218),function(t,e){let r=1,n=0;const i=e.length;let o=0|Math.max(i,624),s=0|t[0];for(;(0|o)>0;--o)t[r]=s=(t[r]^j(s^s>>>30,1664525))+(0|e[n])+(0|n)|0,r=r+1|0,++n,(0|r)>623&&(t[0]=t[623],r=1),n>=i&&(n=0);for(o=623;(0|o)>0;--o)t[r]=s=(t[r]^j(s^s>>>30,1566083941))-r|0,r=r+1|0,(0|r)>623&&(t[0]=t[623],r=1);t[0]=2147483648}(this.data,t),this}}function G(t){let e=0,r=0;for(;(0|e)<227;e=e+1|0)r=2147483648&t[e]|2147483647&t[e+1|0],t[e]=t[e+397|0]^r>>>1^(1&r?q:0);for(;(0|e)<623;e=e+1|0)r=2147483648&t[e]|2147483647&t[e+1|0],t[e]=t[e-227|0]^r>>>1^(1&r?q:0);r=2147483648&t[623]|2147483647&t[0],t[623]=t[396]^r>>>1^(1&r?q:0)}let V=null;let k=128;const _={next:()=>(k>=128&&(V=new Int32Array(new Int8Array(require("crypto").randomBytes(512)).buffer),k=0),0|V[k++])},B=Symbol("engine"),z=Symbol("random"),L={browserCrypto:J,nodeCrypto:_,MersenneTwister19937:MersenneTwister19937,nativeMath:D,min:{next:()=>0},max:{range:[],next(){return this.range[1]-this.range[0]}}};const U=new class NumberGenerator{constructor(t=D){this.engine=t||D}get engine(){return this[B]}set engine(t){if(t&&"function"!=typeof t.next)throw new TypeError("engine must have function `next()`");this[B]=t||D,this[z]=new Random(this[B])}integer(t,e){return this[B].range=[t,e],this[z].integer(t,e)}real(t,e,r=!1){return this[B].range=[t,e],this[z].real(t,e,r)}};var K=Object.freeze({__proto__:null,engines:L,generator:U});const W=Symbol("operator"),H=Symbol("value");class ComparePoint{constructor(t,e){if(!t)throw new RequiredArgumentError("operator");if(!e&&0!==e)throw new RequiredArgumentError("value");this.operator=t,this.value=e}static isValidOperator(t){return"string"==typeof t&&/^(?:[<>!]?=|[<>]|<>)$/.test(t)}set operator(t){if(!this.constructor.isValidOperator(t))throw new CompareOperatorError(t);this[W]=t}get operator(){return this[W]}set value(t){if(!n(t))throw new TypeError("value must be a finite number");this[H]=Number(t)}get value(){return this[H]}isMatch(t){return((t,e,r)=>{const n=Number(t),i=Number(e);let o;if(Number.isNaN(n)||Number.isNaN(i))return!1;switch(r){case"=":case"==":o=n===i;break;case"<":o=n<i;break;case">":o=n>i;break;case"<=":o=n<=i;break;case">=":o=n>=i;break;case"!":case"!=":case"<>":o=n!==i;break;default:o=!1}return o})(t,this.value,this.operator)}toJSON(){const{operator:t,value:e}=this;return{operator:t,type:"compare-point",value:e}}toString(){return`${this.operator}${this.value}`}}class Modifier{constructor(){this.order=999}get name(){return"modifier"}get notation(){return""}get maxIterations(){return 1e3}run(t,e){return t}toJSON(){const{notation:t,name:e}=this;return{name:e,notation:t,type:"modifier"}}toString(){return this.notation}}const Z=Symbol("compare-point");class ComparisonModifier extends Modifier{constructor(t){super(),t&&(this.comparePoint=t)}get comparePoint(){return this[Z]}set comparePoint(t){if(!(t instanceof ComparePoint))throw new TypeError("comparePoint must be instance of ComparePoint");this[Z]=t}get name(){return"comparison"}get notation(){return`${this.comparePoint||""}`}isComparePoint(t){return!!this.comparePoint&&this.comparePoint.isMatch(t)}toJSON(){const{comparePoint:t}=this;return Object.assign(super.toJSON(),{comparePoint:t})}}const X=Symbol("compound"),Q=Symbol("penetrate");class ExplodeModifier extends ComparisonModifier{constructor(t=null,e=!1,r=!1){super(t),this[X]=!!e,this[Q]=!!r,this.order=3}get compound(){return this[X]}get name(){return"explode"}get notation(){return`!${this.compound?"!":""}${this.penetrate?"p":""}${super.notation}`}get penetrate(){return this[Q]}run(t,e){if(e.min===e.max)throw new DieActionValueError(e,"explode");const r=t;return r.rolls=t.rolls.map((t=>{const r=[t];let i=t.value;for(let t=0;t<this.maxIterations&&this.isComparePoint(i);t++){const t=r[r.length-1],n=e.rollOnce();i=n.value,t.modifiers.add("explode"),this.penetrate&&(t.modifiers.add("penetrate"),n.value-=1),r.push(n)}return this.compound&&r.length>1?(t.value=(o=r.map((t=>t.value)),Array.isArray(o)?o.reduce(((t,e)=>t+(n(e)?parseFloat(`${e}`):0)),0):0),t.modifiers=["explode","compound"],this.penetrate&&t.modifiers.add("penetrate"),t):r;var o})).flat(),r}toJSON(){const{compound:t,penetrate:e}=this;return Object.assign(super.toJSON(),{compound:t,penetrate:e})}}const Y=Symbol("text"),tt=Symbol("type");class Description{static types={MULTILINE:"multiline",INLINE:"inline"};constructor(t,e=this.constructor.types.INLINE){this.text=t,this.type=e}get text(){return this[Y]}set text(t){if("object"==typeof t)throw new TypeError("Description text is invalid");if(!t&&0!==t||""===`${t}`.trim())throw new TypeError("Description text cannot be empty");this[Y]=`${t}`.trim()}get type(){return this[tt]}set type(t){const e=Object.values(this.constructor.types);if("string"!=typeof t)throw new TypeError("Description type must be a string");if(!e.includes(t))throw new RangeError(`Description type must be one of; ${e.join(", ")}`);this[tt]=t}toJSON(){const{text:t,type:e}=this;return{text:t,type:e}}toString(){return this.type===this.constructor.types.INLINE?`# ${this.text}`:`[${this.text}]`}}const et=Symbol("description");class HasDescription{constructor(t=null){this.description=t}get description(){return this[et]||null}set description(t){if(t||0===t)if(t instanceof Description)this[et]=t;else{if("string"!=typeof t)throw new TypeError("description must be of type Description, string or null. Received "+typeof t);this[et]=new Description(t)}else this[et]=null}toJSON(){const{description:t}=this;return{description:t}}toString(){return this.description?`${this.description}`:""}}const rt={compound:"!",explode:"!","critical-failure":"__","critical-success":"**",drop:"d",max:"v",min:"^",penetrate:"p","re-roll":"r","re-roll-once":"ro","target-failure":"_","target-success":"*"},nt=(...t)=>[...t].reduce(((t,e)=>{let r;return r=e instanceof Modifier?e.name:e,t+(rt[r]||r)}),""),it=Symbol("calculation-value"),ot=Symbol("modifiers"),st=Symbol("initial-value"),at=Symbol("use-in-total"),ut=Symbol("value");class RollResult{constructor(t,e=[],r=!0){if(n(t))this[st]=Number(t),this.modifiers=e||[],this.useInTotal=r;else{if(!t||"object"!=typeof t||Array.isArray(t))throw t===1/0?new RangeError("Result value must be a finite number"):new TypeError(`Result value is invalid: ${t}`);{const i=n(t.initialValue)?t.initialValue:t.value;if(!n(i))throw new TypeError(`Result value is invalid: ${i}`);this[st]=Number(i),n(t.value)&&Number(t.value)!==this[st]&&(this.value=t.value),n(t.calculationValue)&&parseFloat(`${t.calculationValue}`)!==this.value&&(this.calculationValue=t.calculationValue),this.modifiers=t.modifiers||e||[],this.useInTotal="boolean"==typeof t.useInTotal?t.useInTotal:r||!1}}}get calculationValue(){return n(this[it])?parseFloat(this[it]):this.value}set calculationValue(t){const e=n(t);if(t===1/0)throw new RangeError("Result calculation value must be a finite number");if(t&&!e)throw new TypeError(`Result calculation value is invalid: ${t}`);this[it]=e?parseFloat(`${t}`):null}get initialValue(){return this[st]}get modifierFlags(){return nt(...this.modifiers)}get modifiers(){return this[ot]}set modifiers(t){if((Array.isArray(t)||t instanceof Set)&&[...t].every((t=>"string"==typeof t)))this[ot]=new Set([...t]);else{if(t||0===t)throw new TypeError(`modifiers must be a Set or array of modifier names: ${t}`);this[ot]=new Set}}get useInTotal(){return!!this[at]}set useInTotal(t){this[at]=!!t}get value(){return n(this[ut])?this[ut]:this[st]}set value(t){if(t===1/0)throw new RangeError("Result value must be a finite number");if(!n(t))throw new TypeError(`Result value is invalid: ${t}`);this[ut]=Number(t)}toJSON(){const{calculationValue:t,initialValue:e,modifierFlags:r,modifiers:n,useInTotal:i,value:o}=this;return{calculationValue:t,initialValue:e,modifierFlags:r,modifiers:[...n],type:"result",useInTotal:i,value:o}}toString(){return this.value+this.modifierFlags}}const lt=Symbol("rolls");class RollResults{constructor(t=[]){this.rolls=t}get length(){return this.rolls.length||0}get rolls(){return[...this[lt]]}set rolls(t){if(!t||!Array.isArray(t))throw new TypeError(`rolls must be an array: ${t}`);this[lt]=[],t.forEach((t=>{this.addRoll(t)}))}get value(){return this.rolls.reduce(((t,e)=>t+(e.useInTotal?e.calculationValue:0)),0)}addRoll(t){const e=t instanceof RollResult?t:new RollResult(t);this[lt].push(e)}toJSON(){const{rolls:t,value:e}=this;return{rolls:t,type:"roll-results",value:e}}toString(){return`[${this.rolls.join(", ")}]`}}const ct=Symbol("once");class ReRollModifier extends ComparisonModifier{constructor(t=!1,e=null){super(e),this.once=!!t,this.order=4}get name(){return"re-roll"}get notation(){return`r${this.once?"o":""}${super.notation}`}get once(){return!!this[ct]}set once(t){this[ct]=!!t}run(t,e){if(e.min===e.max)throw new DieActionValueError(e,"re-roll");return t.rolls.map((t=>{for(let r=0;r<this.maxIterations&&this.isComparePoint(t.value);r++){const r=e.rollOnce();if(t.value=r.value,t.modifiers.add("re-roll"+(this.once?"-once":"")),this.once)break}return t})),t}toJSON(){const{once:t}=this;return Object.assign(super.toJSON(),{once:t})}}const ht=Symbol("modifiers"),ft=Symbol("qty"),pt=Symbol("sides"),dt=Symbol("min-value"),mt=Symbol("max-value");class StandardDice extends HasDescription{constructor(t,e=1,r=null,o=1,s=null,a=null){if(super(a),!t&&0!==t)throw new RequiredArgumentError("sides");if(t===1/0)throw new RangeError("numerical sides must be finite number");if(n(t)){if(t<1||!i(t))throw new RangeError("numerical sides must be a positive finite number")}else if("string"!=typeof t)throw new TypeError("non-numerical sides must be a string");if(!n(e))throw new TypeError("qty must be a positive finite integer");if(e<1||e>999)throw new RangeError("qty must be between 1 and 999");let u=o;if(null==u)u=1;else{if(!n(u))throw new TypeError("min must a finite number");if(!i(u))throw new RangeError("min must a finite number")}if(s&&!n(s))throw new TypeError("max must a finite number");if(s&&!i(s))throw new RangeError("max must a finite number");this[ft]=parseInt(`${e}`,10),this[pt]=t,r&&(this.modifiers=r),this[dt]=parseInt(u,10),this[mt]=s?parseInt(`${s}`,10):t}get average(){return(this.min+this.max)/2}get modifiers(){return this[ht]?new Map([...this[ht]].sort(((t,e)=>t[1].order-e[1].order))):null}set modifiers(t){let e;if(t instanceof Map)e=t;else if(Array.isArray(t))e=new Map(t.map((t=>[t.name,t])));else{if("object"!=typeof t)throw new TypeError("modifiers should be a Map, array, or an Object containing Modifiers");e=new Map(Object.entries(t))}if(e.size&&[...e.entries()].some((t=>!(t[1]instanceof Modifier))))throw new TypeError("modifiers must only contain Modifier instances");this[ht]=e,this[ht].forEach((t=>{t instanceof ExplodeModifier&&!t.comparePoint?t.comparePoint=new ComparePoint("=",this.max):t instanceof ReRollModifier&&!t.comparePoint&&(t.comparePoint=new ComparePoint("=",this.min))}))}get max(){return this[mt]}get min(){return this[dt]}get name(){return"standard"}get notation(){let t=`${this.qty}d${this.sides}`;return this.modifiers&&this.modifiers.size&&(t+=[...this.modifiers.values()].reduce(((t,e)=>t+e.notation),"")),t}get qty(){return this[ft]}get sides(){return this[pt]}roll(){const t=new RollResults;for(let e=0;e<this.qty;e++)t.addRoll(this.rollOnce());return(this.modifiers||[]).forEach((e=>{e.run(t,this)})),t}rollOnce(){return new RollResult(U.integer(this.min,this.max))}toJSON(){const{average:t,max:e,min:r,modifiers:n,name:i,notation:o,qty:s,sides:a}=this;return Object.assign(super.toJSON(),{average:t,max:e,min:r,modifiers:n,name:i,notation:o,qty:s,sides:a,type:"die"})}toString(){return`${this.notation}${this.description?` ${this.description}`:""}`}}class FudgeDice extends StandardDice{constructor(t=2,e=1,r=null,n=null){let i=t;if(i||0===i){if(1!==i&&2!==i)throw new RangeError("nonBlanks must be 1 or 2")}else i=2;super(i,e,r,-1,1,n)}get name(){return"fudge"}get nonBlanks(){return super.sides}get sides(){return`F.${this.nonBlanks}`}rollOnce(){let t=0;if(2===this.nonBlanks)t=U.integer(1,3)-2;else if(1===this.nonBlanks){const e=U.integer(1,6);1===e?t=-1:6===e&&(t=1)}return new RollResult(t)}}class PercentileDice extends StandardDice{constructor(t=1,e=null,r=!1,n=null){super(100,t,e,null,null,n),this.sidesAsNumber=!!r}get name(){return"percentile"}get sides(){return this.sidesAsNumber?super.sides:"%"}}var gt=Object.freeze({__proto__:null,FudgeDice:FudgeDice,PercentileDice:PercentileDice,StandardDice:StandardDice});class CriticalFailureModifier extends ComparisonModifier{constructor(t){super(t),this.order=9}get name(){return"critical-failure"}get notation(){return`cf${super.notation}`}run(t,e){return t.rolls.forEach((t=>(this.isComparePoint(t.value)&&t.modifiers.add("critical-failure"),t))),t}}class CriticalSuccessModifier extends ComparisonModifier{constructor(t){super(t),this.order=8}get name(){return"critical-success"}get notation(){return`cs${super.notation}`}run(t,e){return t.rolls.forEach((t=>(this.isComparePoint(t.value)&&t.modifiers.add("critical-success"),t))),t}}const yt=Symbol("calculation-value"),wt=Symbol("is-roll-group"),bt=Symbol("modifiers"),xt=Symbol("results"),vt=Symbol("use-in-total");class ResultGroup{constructor(t=[],e=[],r=!1,n=!0){this.isRollGroup=r,this.modifiers=e,this.results=t,this.useInTotal=n}get calculationValue(){return n(this[yt])?parseFloat(this[yt]):this.value}set calculationValue(t){const e=n(t);if(t===1/0)throw new RangeError("Results calculation value must be a finite number");if(t&&!e)throw new TypeError(`Results calculation value is invalid: ${t}`);this[yt]=e?parseFloat(`${t}`):null}get isRollGroup(){return this[wt]}set isRollGroup(t){this[wt]=!!t}get length(){return this.results.length||0}get modifierFlags(){return nt(...this.modifiers)}get modifiers(){return this[bt]}set modifiers(t){if((Array.isArray(t)||t instanceof Set)&&[...t].every((t=>"string"==typeof t)))this[bt]=new Set([...t]);else{if(t||0===t)throw new TypeError(`modifiers must be a Set or array of modifier names: ${t}`);this[bt]=new Set}}get results(){return[...this[xt]]}set results(t){if(!t||!Array.isArray(t))throw new TypeError(`results must be an array: ${t}`);this[xt]=[],t.forEach((t=>{this.addResult(t)}))}get useInTotal(){return!!this[vt]}set useInTotal(t){this[vt]=!!t}get value(){if(!this.results.length)return 0;const t=this.results.reduce(((t,e)=>{let r=e;return e instanceof ResultGroup?r=e.useInTotal?e.calculationValue:0:e instanceof RollResults&&(r=e.value),t+r}),"string"==typeof this.results[0]?"":0);return"string"==typeof t?r(t):t}addResult(t){let e;if(t instanceof ResultGroup||t instanceof RollResults)e=t;else{if("string"!=typeof t&&!n(t))throw new TypeError("value must be one of ResultGroup, RollResults, string, or number");e=t}this[xt].push(e)}toJSON(){const{calculationValue:t,isRollGroup:e,modifierFlags:r,modifiers:n,results:i,useInTotal:o,value:s}=this;return{calculationValue:t,isRollGroup:e,modifierFlags:r,modifiers:[...n],results:i,type:"result-group",useInTotal:o,value:s}}toString(){let t;return t=this.isRollGroup?`{${this.results.join(", ")}}`:this.results.join(""),this.modifierFlags&&(t=`(${t})${this.modifierFlags}`),t}}const Et=Symbol("end"),St=Symbol("qty");class KeepModifier extends Modifier{constructor(t="h",e=1){super(),this.end=t,this.qty=e,this.order=5}get end(){return this[Et]}set end(t){if("h"!==t&&"l"!==t)throw new RangeError('End must be "h" or "l"');this[Et]=t}get name(){return`keep-${this.end}`}get notation(){return`k${this.end}${this.qty}`}get qty(){return this[St]}set qty(t){if(t===1/0)throw new RangeError("qty must be a finite number");if(!n(t)||t<1)throw new TypeError("qty must be a positive finite integer");this[St]=Math.floor(t)}rangeToDrop(t){return"h"===this.end?[0,t.length-this.qty]:[this.qty,t.length]}run(t,e){let r,n;return t instanceof ResultGroup?(r=t.results,n=1===r.length&&r[0]instanceof ResultGroup?r[0].results.map(((t,e)=>t instanceof RollResults?t.rolls.map(((t,r)=>({value:t.value,index:[e,r]}))):null)).flat().filter(Boolean):[...r].map(((t,e)=>({value:t.value,index:e})))):(r=t.rolls,n=[...r].map(((t,e)=>({value:t.value,index:e})))),n=n.sort(((t,e)=>t.value-e.value)).map((t=>t.index)).slice(...this.rangeToDrop(n)),n.forEach((t=>{let e;e=Array.isArray(t)?r[0].results[t[0]].rolls[t[1]]:r[t],e.modifiers.add("drop"),e.useInTotal=!1})),t}toJSON(){const{end:t,qty:e}=this;return Object.assign(super.toJSON(),{end:t,qty:e})}}class DropModifier extends KeepModifier{constructor(t="l",e=1){super(t,e),this.order=6}get name(){return`drop-${this.end}`}get notation(){return`d${this.end}${this.qty}`}rangeToDrop(t){return"h"===this.end?[t.length-this.qty,t.length]:[0,this.qty]}}const Rt=Symbol("max");class MaxModifier extends Modifier{constructor(t){super(),this.max=t,this.order=2}get max(){return this[Rt]}set max(t){if(!n(t))throw new TypeError("max must be a number");this[Rt]=parseFloat(`${t}`)}get name(){return"max"}get notation(){return`max${this.max}`}run(t,e){const r=t;return r.rolls=t.rolls.map((t=>{const e=t;return t.value>this.max&&(e.value=this.max,e.modifiers.add("max")),e})),r}toJSON(){const{max:t}=this;return Object.assign(super.toJSON(),{max:t})}}const At=Symbol("min");class MinModifier extends Modifier{constructor(t){super(),this.min=t,this.order=1}get min(){return this[At]}set min(t){if(!n(t))throw new TypeError("min must be a number");this[At]=parseFloat(`${t}`)}get name(){return"min"}get notation(){return`min${this.min}`}run(t,e){const r=t;return r.rolls=t.rolls.map((t=>{const e=t;return t.value<this.min&&(e.value=this.min,e.modifiers.add("min")),e})),r}toJSON(){const{min:t}=this;return Object.assign(super.toJSON(),{min:t})}}const Mt=Symbol("direction");class SortingModifier extends Modifier{constructor(t="a"){super(),this.direction=t,this.order=10}get direction(){return this[Mt]}set direction(t){if("a"!==t&&"d"!==t)throw new RangeError('Direction must be "a" (Ascending) or "d" (Descending)');this[Mt]=t}get name(){return"sorting"}get notation(){return`s${this.direction}`}run(t,e){let r;return r=t instanceof ResultGroup?"results":"rolls",t[r]=t[r].sort(((t,e)=>"d"===this.direction?e.value-t.value:t.value-e.value)),t instanceof ResultGroup&&(t[r]=t[r].map((t=>t instanceof ResultGroup||t instanceof RollResults?this.run(t,e):t))),t}toJSON(){const{direction:t}=this;return Object.assign(super.toJSON(),{direction:t})}}const Tt=Symbol("failure-cp");class TargetModifier extends ComparisonModifier{constructor(t,e=null){super(t),this.failureComparePoint=e,this.order=7}get failureComparePoint(){return this[Tt]}set failureComparePoint(t){if(t&&!(t instanceof ComparePoint))throw new TypeError("failure comparePoint must be instance of ComparePoint or null");this[Tt]=t||null}get name(){return"target"}get notation(){return`${super.notation}${this.failureComparePoint?`f${this.failureComparePoint}`:""}`}get successComparePoint(){return this.comparePoint}set successComparePoint(t){super.comparePoint=t}getStateValue(t){return this.isSuccess(t)?1:this.isFailure(t)?-1:0}isFailure(t){return!!this.failureComparePoint&&this.failureComparePoint.isMatch(t)}isNeutral(t){return!this.isSuccess(t)&&!this.isFailure(t)}isSuccess(t){return this.isComparePoint(t)}run(t,e){let r;return r=t instanceof ResultGroup?t.results:t.rolls,r.forEach((t=>{this.isSuccess(t.value)?t.modifiers.add("target-success"):this.isFailure(t.value)&&t.modifiers.add("target-failure"),t.calculationValue=this.getStateValue(t.value)})),t}toJSON(){const{failureComparePoint:t,successComparePoint:e}=this,r=super.toJSON();return delete r.comparePoint,Object.assign(r,{failureComparePoint:t,successComparePoint:e})}}var Ct=Object.freeze({__proto__:null,ComparisonModifier:ComparisonModifier,CriticalFailureModifier:CriticalFailureModifier,CriticalSuccessModifier:CriticalSuccessModifier,DropModifier:DropModifier,ExplodeModifier:ExplodeModifier,KeepModifier:KeepModifier,MaxModifier:MaxModifier,MinModifier:MinModifier,Modifier:Modifier,ReRollModifier:ReRollModifier,SortingModifier:SortingModifier,TargetModifier:TargetModifier}),Nt=Object.freeze({__proto__:null,ResultGroup:ResultGroup,RollResult:RollResult,RollResults:RollResults});const Ot=t=>{try{return!(!t||btoa(atob(t))!==t)}catch(t){return!1}},$t=t=>{try{const e=!!t&&JSON.parse(t);return!(!e||"object"!=typeof e)}catch(t){return!1}},Dt=Symbol("expressions"),Ft=Symbol("modifiers");class RollGroup extends HasDescription{constructor(t=[],e=[],r=null){super(r),this.expressions=t,this.modifiers=e}get expressions(){return[...this[Dt]||[]]}set expressions(t){if(!t)throw new RequiredArgumentError("expressions");if(!Array.isArray(t))throw new TypeError(`expressions must be an array: ${t}`);this[Dt]=[],t.forEach((e=>{if(!e||!Array.isArray(e))throw new TypeError(`Expressions must be an array of arrays: ${t}`);if(0===e.length)throw new TypeError(`Sub expressions cannot be empty: ${t}`);if(!e.every((t=>t instanceof StandardDice||"string"==typeof t||"number"==typeof t)))throw new TypeError("Sub expression items must be Dice, numbers, or strings");this[Dt].push(e)}))}get modifiers(){return this[Ft]?new Map([...this[Ft]].sort(((t,e)=>t[1].order-e[1].order))):null}set modifiers(t){let e;if(t instanceof Map)e=t;else if(Array.isArray(t))e=new Map(t.map((t=>[t.name,t])));else{if("object"!=typeof t)throw new TypeError("modifiers should be a Map, array, or an Object containing Modifiers");e=new Map(Object.entries(t))}if(e.size&&[...e.entries()].some((t=>!(t[1]instanceof Modifier))))throw new TypeError("modifiers must only contain Modifier instances");this[Ft]=e}get notation(){let t=this.expressions.map((t=>t.reduce(((t,e)=>t+e),""))).join(", ");return t=`{${t}}`,this.modifiers&&this.modifiers.size&&(t+=[...this.modifiers.values()].reduce(((t,e)=>t+e.notation),"")),t}roll(){const t=new ResultGroup(this.expressions.map((t=>{const e=t.map((t=>t instanceof StandardDice?t.roll():t));return new ResultGroup(e)})));return t.isRollGroup=!0,(this.modifiers||[]).forEach((e=>{e.run(t,this)})),t}toJSON(){const{modifiers:t,notation:e,expressions:r}=this;return Object.assign(super.toJSON(),{expressions:r,modifiers:t,notation:e,type:"group"})}toString(){return`${this.notation}${this.description?` ${this.description}`:""}`}}function Pt(t,e,r,n){var i=Error.call(this,t);return Object.setPrototypeOf&&Object.setPrototypeOf(i,Pt.prototype),i.expected=e,i.found=r,i.location=n,i.name="SyntaxError",i}function It(t,e,r){return r=r||" ",t.length>e?t:(e-=t.length,t+(r+=r.repeat(e)).slice(0,e))}function Jt(t,e){var n,i,o,s,a={},u=(e=void 0!==e?e:{}).grammarSource,l={Main:xe},c=xe,h=",",f="d",p="d%",d="dF",m="!",g="max",y="min",w="cs",b="cf",x="!=",v="<=",E=">=",S="<>",R="(",A=")",M="abs",T="ceil",C="cos",N="exp",O="floor",$="log",D="round",F="sign",P="sin",I="sqrt",J="tan",j="pow",q="/*",G="*/",V="//",k=/^[12]/,_=/^[lh]/,B=/^[.]/,z=/^[1-9]/,L=/^[0-9]/,U=/^[^\]]/,K=/^[\n\r\u2028\u2029]/,W=/^[ \t\n\r]/,H=de("{",!1),Z=de(",",!1),X=de("}",!1),Q=de("d",!1),Y=de("d%",!1),tt=de("dF",!1),et=de(".",!1),rt=me(["1","2"],!1,!1),nt=de("!",!1),it=de("p",!1),ot=me(["l","h"],!1,!1),st=de("k",!1),at=de("max",!1),ut=de("min",!1),lt=de("r",!1),ct=de("o",!1),ht=de("cs",!1),ft=de("cf",!1),pt=de("s",!1),dt=de("a",!1),mt=de("f",!1),gt=de("!=",!1),yt=de("<=",!1),wt=de(">=",!1),bt=de("=",!1),xt=de("<>",!1),vt=de(">",!1),Et=de("<",!1),St=de("(",!1),Rt=de(")",!1),At=de("abs",!1),Mt=de("ceil",!1),Tt=de("cos",!1),Ct=de("exp",!1),Nt=de("floor",!1),Ot=de("log",!1),$t=de("round",!1),Dt=de("sign",!1),Ft=de("sin",!1),It=de("sqrt",!1),Jt=de("tan",!1),jt=de("pow",!1),qt=de("-",!1),Gt=me(["."],!1,!1),Vt=me([["1","9"]],!1,!1),kt=me([["0","9"]],!1,!1),_t=de("**",!1),Bt=de("*",!1),zt=de("^",!1),Lt=de("%",!1),Ut=de("/",!1),Kt=de("+",!1),Wt=ge("comment"),Ht=de("/*",!1),Zt=de("*/",!1),Xt={type:"any"},Qt=de("[",!1),Yt=me(["]"],!0,!1),te=de("]",!1),ee=de("//",!1),re=de("#",!1),ne=me(["\n","\r","\u2028","\u2029"],!1,!1),ie=ge("whitespace"),oe=me([" ","\t","\n","\r"],!1,!1),se=ge("whitespace or comment"),ae=0,ue=0,le=[{line:1,column:1}],ce=0,he=[],fe=0;if("startRule"in e){if(!(e.startRule in l))throw new Error("Can't start parsing from rule \""+e.startRule+'".');c=l[e.startRule]}function pe(){return t.substring(ue,ae)}function de(t,e){return{type:"literal",text:t,ignoreCase:e}}function me(t,e,r){return{type:"class",parts:t,inverted:e,ignoreCase:r}}function ge(t){return{type:"other",description:t}}function ye(e){var r,n=le[e];if(n)return n;for(r=e-1;!le[r];)r--;for(n={line:(n=le[r]).line,column:n.column};r<e;)10===t.charCodeAt(r)?(n.line++,n.column=1):n.column++,r++;return le[e]=n,n}function we(t,e){var r=ye(t),n=ye(e);return{source:u,start:{offset:t,line:r.line,column:r.column},end:{offset:e,line:n.line,column:n.column}}}function be(t){ae<ce||(ae>ce&&(ce=ae,he=[]),he.push(t))}function xe(){return Me()}function ve(){var e,r,n,i,o,s,u,l,c,h,f;if(e=ae,123===t.charCodeAt(ae)?(r="{",ae++):(r=a,0===fe&&be(H)),r!==a)if(Ie(),(n=Me())!==a){for(i=[],o=ae,s=Ie(),44===t.charCodeAt(ae)?(u=",",ae++):(u=a,0===fe&&be(Z)),u!==a?(l=Ie(),(c=Me())!==a?o=s=[s,u,l,c]:(ae=o,o=a)):(ae=o,o=a);o!==a;)i.push(o),o=ae,s=Ie(),44===t.charCodeAt(ae)?(u=",",ae++):(u=a,0===fe&&be(Z)),u!==a?(l=Ie(),(c=Me())!==a?o=s=[s,u,l,c]:(ae=o,o=a)):(ae=o,o=a);if(o=Ie(),125===t.charCodeAt(ae)?(s="}",ae++):(s=a,0===fe&&be(X)),s!==a){for(u=[],l=Se();l!==a;)u.push(l),l=Se();l=Je(),ue=e,h=u,f=l,e=new RollGroup([n,...i.map((t=>t[3]))],Object.assign({},...h.map((t=>({[t.name]:t})))),f.find((t=>t instanceof Description)))}else ae=e,e=a}else ae=e,e=a;else ae=e,e=a;return e}function Ee(){var e,r,n,i;if(e=ae,r=function(){var e,r,n,i;e=ae,(r=Ae())===a&&(r=null);100===t.charCodeAt(ae)?(n=f,ae++):(n=a,0===fe&&be(Q));n!==a&&(i=Ae())!==a?(ue=e,e=new StandardDice(i,r||1)):(ae=e,e=a);return e}(),r===a&&(r=function(){var e,r,n;e=ae,(r=Ae())===a&&(r=null);t.substr(ae,2)===p?(n=p,ae+=2):(n=a,0===fe&&be(Y));n!==a?(ue=e,e=new PercentileDice(r||1)):(ae=e,e=a);return e}(),r===a&&(r=function(){var e,r,n,i,o,s;e=ae,(r=Ae())===a&&(r=null);t.substr(ae,2)===d?(n=d,ae+=2):(n=a,0===fe&&be(tt));n!==a?(i=ae,46===t.charCodeAt(ae)?(o=".",ae++):(o=a,0===fe&&be(et)),o!==a?(k.test(t.charAt(ae))?(s=t.charAt(ae),ae++):(s=a,0===fe&&be(rt)),s!==a?i=o=[o,s]:(ae=i,i=a)):(ae=i,i=a),i===a&&(i=null),ue=e,u=r,e=new FudgeDice((l=i)?parseInt(l[1],10):2,u||1)):(ae=e,e=a);var u,l;return e}())),r!==a){for(n=[],i=Se();i!==a;)n.push(i),i=Se();i=Je(),ue=e,e=function(t,e,r){return t.modifiers=Object.assign({},...e.map((t=>({[t.name]:t})))),t.description=r.find((t=>t instanceof Description)),t}(r,n,i)}else ae=e,e=a;return e}function Se(){var e;return(e=function(){var e,r,n,i,o;e=ae,33===t.charCodeAt(ae)?(r=m,ae++):(r=a,0===fe&&be(nt));r!==a?(33===t.charCodeAt(ae)?(n=m,ae++):(n=a,0===fe&&be(nt)),n===a&&(n=null),112===t.charCodeAt(ae)?(i="p",ae++):(i=a,0===fe&&be(it)),i===a&&(i=null),(o=Re())===a&&(o=null),ue=e,e=new ExplodeModifier(o,!!n,!!i)):(ae=e,e=a);return e}())===a&&(e=function(){var e,r,n;e=ae,(r=Re())!==a?(n=function(){var e,r,n;e=ae,102===t.charCodeAt(ae)?(r="f",ae++):(r=a,0===fe&&be(mt));r!==a&&(n=Re())!==a?(ue=e,e=n):(ae=e,e=a);return e}(),n===a&&(n=null),ue=e,e=new TargetModifier(r,n)):(ae=e,e=a);return e}())===a&&(e=function(){var e,r,n,i;e=ae,100===t.charCodeAt(ae)?(r=f,ae++):(r=a,0===fe&&be(Q));r!==a?(_.test(t.charAt(ae))?(n=t.charAt(ae),ae++):(n=a,0===fe&&be(ot)),n===a&&(n=null),(i=Ne())!==a?(ue=e,e=new DropModifier(n||"l",i)):(ae=e,e=a)):(ae=e,e=a);return e}())===a&&(e=function(){var e,r,n,i;e=ae,107===t.charCodeAt(ae)?(r="k",ae++):(r=a,0===fe&&be(st));r!==a?(_.test(t.charAt(ae))?(n=t.charAt(ae),ae++):(n=a,0===fe&&be(ot)),n===a&&(n=null),(i=Ne())!==a?(ue=e,e=new KeepModifier(n||"h",i)):(ae=e,e=a)):(ae=e,e=a);return e}())===a&&(e=function(){var e,r,n,i;e=ae,114===t.charCodeAt(ae)?(r="r",ae++):(r=a,0===fe&&be(lt));r!==a?(111===t.charCodeAt(ae)?(n="o",ae++):(n=a,0===fe&&be(ct)),n===a&&(n=null),(i=Re())===a&&(i=null),ue=e,e=new ReRollModifier(!!n,i)):(ae=e,e=a);return e}())===a&&(e=function(){var e,r,n;e=ae,t.substr(ae,2)===w?(r=w,ae+=2):(r=a,0===fe&&be(ht));r!==a&&(n=Re())!==a?(ue=e,e=new CriticalSuccessModifier(n)):(ae=e,e=a);return e}())===a&&(e=function(){var e,r,n;e=ae,t.substr(ae,2)===b?(r=b,ae+=2):(r=a,0===fe&&be(ft));r!==a&&(n=Re())!==a?(ue=e,e=new CriticalFailureModifier(n)):(ae=e,e=a);return e}())===a&&(e=function(){var e,r,n;e=ae,115===t.charCodeAt(ae)?(r="s",ae++):(r=a,0===fe&&be(pt));r!==a?(97===t.charCodeAt(ae)?(n="a",ae++):(n=a,0===fe&&be(dt)),n===a&&(100===t.charCodeAt(ae)?(n=f,ae++):(n=a,0===fe&&be(Q))),n===a&&(n=null),ue=e,e=new SortingModifier(n||"a")):(ae=e,e=a);return e}())===a&&(e=function(){var e,r,n;e=ae,t.substr(ae,3)===g?(r=g,ae+=3):(r=a,0===fe&&be(at));r!==a&&(n=Ce())!==a?(ue=e,e=new MaxModifier(n)):(ae=e,e=a);return e}())===a&&(e=function(){var e,r,n;e=ae,t.substr(ae,3)===y?(r=y,ae+=3):(r=a,0===fe&&be(ut));r!==a&&(n=Ce())!==a?(ue=e,e=new MinModifier(n)):(ae=e,e=a);return e}()),e}function Re(){var e,r,n;return e=ae,r=function(){var e;t.substr(ae,2)===x?(e=x,ae+=2):(e=a,0===fe&&be(gt));e===a&&(t.substr(ae,2)===v?(e=v,ae+=2):(e=a,0===fe&&be(yt)),e===a&&(t.substr(ae,2)===E?(e=E,ae+=2):(e=a,0===fe&&be(wt)),e===a&&(61===t.charCodeAt(ae)?(e="=",ae++):(e=a,0===fe&&be(bt)),e===a&&(t.substr(ae,2)===S?(e=S,ae+=2):(e=a,0===fe&&be(xt)),e===a&&(62===t.charCodeAt(ae)?(e=">",ae++):(e=a,0===fe&&be(vt)),e===a&&(60===t.charCodeAt(ae)?(e="<",ae++):(e=a,0===fe&&be(Et))))))));return e}(),r!==a&&(n=Ce())!==a?(ue=e,e=new ComparePoint(r,n)):(ae=e,e=a),e}function Ae(){var e,n,i,o,s,u,l,c,h,f;if((e=Ne())===a)if(e=ae,40===t.charCodeAt(ae)?(n=R,ae++):(n=a,0===fe&&be(St)),n!==a){if(Ie(),i=ae,(o=Ce())!==a){if(s=[],u=ae,l=Ie(),(c=$e())!==a?(h=Ie(),(f=Ce())!==a?u=l=[l,c,h,f]:(ae=u,u=a)):(ae=u,u=a),u!==a)for(;u!==a;)s.push(u),u=ae,l=Ie(),(c=$e())!==a?(h=Ie(),(f=Ce())!==a?u=l=[l,c,h,f]:(ae=u,u=a)):(ae=u,u=a);else s=a;s!==a?i=o=[o,s]:(ae=i,i=a)}else ae=i,i=a;i!==a?(o=Ie(),41===t.charCodeAt(ae)?(s=A,ae++):(s=a,0===fe&&be(Rt)),s!==a?(ue=e,e=r(pe())):(ae=e,e=a)):(ae=e,e=a)}else ae=e,e=a;return e}function Me(){var t,e,r,n,i,o,s,u,l,c;if(t=ae,(e=Te())!==a){for(r=[],n=ae,i=Ie(),(o=$e())!==a?(s=Ie(),(u=Te())!==a?n=i=[i,o,s,u]:(ae=n,n=a)):(ae=n,n=a);n!==a;)r.push(n),n=ae,i=Ie(),(o=$e())!==a?(s=Ie(),(u=Te())!==a?n=i=[i,o,s,u]:(ae=n,n=a)):(ae=n,n=a);ue=t,l=e,c=r,l=Array.isArray(l)?l:[l],t=[...l,...c.map((([,t,,e])=>[t,e])).flat(2)]}else ae=t,t=a;return t}function Te(){var e,r,n,i,o,s;return e=function(){var e,r,n,i,o,s,u;e=ae,t.substr(ae,3)===M?(r=M,ae+=3):(r=a,0===fe&&be(At));r===a&&(t.substr(ae,4)===T?(r=T,ae+=4):(r=a,0===fe&&be(Mt)),r===a&&(t.substr(ae,3)===C?(r=C,ae+=3):(r=a,0===fe&&be(Tt)),r===a&&(t.substr(ae,3)===N?(r=N,ae+=3):(r=a,0===fe&&be(Ct)),r===a&&(t.substr(ae,5)===O?(r=O,ae+=5):(r=a,0===fe&&be(Nt)),r===a&&(t.substr(ae,3)===$?(r=$,ae+=3):(r=a,0===fe&&be(Ot)),r===a&&(t.substr(ae,5)===D?(r=D,ae+=5):(r=a,0===fe&&be($t)),r===a&&(t.substr(ae,4)===F?(r=F,ae+=4):(r=a,0===fe&&be(Dt)),r===a&&(t.substr(ae,3)===P?(r=P,ae+=3):(r=a,0===fe&&be(Ft)),r===a&&(t.substr(ae,4)===I?(r=I,ae+=4):(r=a,0===fe&&be(It)),r===a&&(t.substr(ae,3)===J?(r=J,ae+=3):(r=a,0===fe&&be(Jt))))))))))));r!==a?(40===t.charCodeAt(ae)?(n=R,ae++):(n=a,0===fe&&be(St)),n!==a?(Ie(),(i=Me())!==a?(Ie(),41===t.charCodeAt(ae)?(o=A,ae++):(o=a,0===fe&&be(Rt)),o!==a?(ue=e,l=i,e=[`${r}(`,...l,")"]):(ae=e,e=a)):(ae=e,e=a)):(ae=e,e=a)):(ae=e,e=a);var l;e===a&&(e=ae,t.substr(ae,3)===j?(r=j,ae+=3):(r=a,0===fe&&be(jt)),r===a&&(t.substr(ae,3)===g?(r=g,ae+=3):(r=a,0===fe&&be(at)),r===a&&(t.substr(ae,3)===y?(r=y,ae+=3):(r=a,0===fe&&be(ut)))),r!==a?(40===t.charCodeAt(ae)?(n=R,ae++):(n=a,0===fe&&be(St)),n!==a?(Ie(),(i=Me())!==a?(Ie(),44===t.charCodeAt(ae)?(o=h,ae++):(o=a,0===fe&&be(Z)),o!==a?(Ie(),(s=Me())!==a?(Ie(),41===t.charCodeAt(ae)?(u=A,ae++):(u=a,0===fe&&be(Rt)),u!==a?(ue=e,e=function(t,e,r){return[`${t}(`,...e,",",...r,")"]}(r,i,s)):(ae=e,e=a)):(ae=e,e=a)):(ae=e,e=a)):(ae=e,e=a)):(ae=e,e=a)):(ae=e,e=a));return e}(),e===a&&(e=Ee())===a&&(e=Ce())===a&&(e=ae,40===t.charCodeAt(ae)?(r=R,ae++):(r=a,0===fe&&be(St)),r!==a?(Ie(),(n=Me())!==a?(Ie(),41===t.charCodeAt(ae)?(i=A,ae++):(i=a,0===fe&&be(Rt)),i!==a?(ue=e,o=n,s=i,e=[r,...o,s]):(ae=e,e=a)):(ae=e,e=a)):(ae=e,e=a),e===a&&(e=ve())),e}function Ce(){var e,r,n,i;return e=ae,45===t.charCodeAt(ae)?ae++:0===fe&&be(qt),Oe()!==a?(r=ae,B.test(t.charAt(ae))?(n=t.charAt(ae),ae++):(n=a,0===fe&&be(Gt)),n!==a&&(i=Oe())!==a?r=n=[n,i]:(ae=r,r=a),r===a&&(r=null),ue=e,e=parseFloat(pe())):(ae=e,e=a),e}function Ne(){var e,r,n,i;if(e=ae,z.test(t.charAt(ae))?(r=t.charAt(ae),ae++):(r=a,0===fe&&be(Vt)),r!==a){for(n=[],L.test(t.charAt(ae))?(i=t.charAt(ae),ae++):(i=a,0===fe&&be(kt));i!==a;)n.push(i),L.test(t.charAt(ae))?(i=t.charAt(ae),ae++):(i=a,0===fe&&be(kt));ue=e,e=parseInt(pe(),10)}else ae=e,e=a;return e}function Oe(){var e,r,n;if(e=ae,r=[],L.test(t.charAt(ae))?(n=t.charAt(ae),ae++):(n=a,0===fe&&be(kt)),n!==a)for(;n!==a;)r.push(n),L.test(t.charAt(ae))?(n=t.charAt(ae),ae++):(n=a,0===fe&&be(kt));else r=a;return r!==a&&(ue=e,r=parseInt(pe(),10)),e=r}function $e(){var e,r;return e=ae,"**"===t.substr(ae,2)?(r="**",ae+=2):(r=a,0===fe&&be(_t)),r!==a&&(ue=e,r="^"),(e=r)===a&&(42===t.charCodeAt(ae)?(e="*",ae++):(e=a,0===fe&&be(Bt)),e===a&&(94===t.charCodeAt(ae)?(e="^",ae++):(e=a,0===fe&&be(zt)),e===a&&(37===t.charCodeAt(ae)?(e="%",ae++):(e=a,0===fe&&be(Lt)),e===a&&(47===t.charCodeAt(ae)?(e="/",ae++):(e=a,0===fe&&be(Ut)),e===a&&(43===t.charCodeAt(ae)?(e="+",ae++):(e=a,0===fe&&be(Kt)),e===a&&(45===t.charCodeAt(ae)?(e="-",ae++):(e=a,0===fe&&be(qt)))))))),e}function De(){var e;return fe++,e=function(){var e,r,n,i,o,s;e=ae,t.substr(ae,2)===q?(r=q,ae+=2):(r=a,0===fe&&be(Ht));if(r!==a){for(n=[],i=ae,o=ae,fe++,t.substr(ae,2)===G?(s=G,ae+=2):(s=a,0===fe&&be(Zt)),fe--,s===a?o=void 0:(ae=o,o=a),o!==a?(t.length>ae?(s=t.charAt(ae),ae++):(s=a,0===fe&&be(Xt)),s!==a?i=o=[o,s]:(ae=i,i=a)):(ae=i,i=a);i!==a;)n.push(i),i=ae,o=ae,fe++,t.substr(ae,2)===G?(s=G,ae+=2):(s=a,0===fe&&be(Zt)),fe--,s===a?o=void 0:(ae=o,o=a),o!==a?(t.length>ae?(s=t.charAt(ae),ae++):(s=a,0===fe&&be(Xt)),s!==a?i=o=[o,s]:(ae=i,i=a)):(ae=i,i=a);t.substr(ae,2)===G?(i=G,ae+=2):(i=a,0===fe&&be(Zt)),i!==a?(ue=e,e=function(t){return new Description(t.flat().join(""),Description.types.MULTILINE)}(n)):(ae=e,e=a)}else ae=e,e=a;if(e===a)if(e=ae,91===t.charCodeAt(ae)?(r="[",ae++):(r=a,0===fe&&be(Qt)),r!==a){for(n=[],U.test(t.charAt(ae))?(i=t.charAt(ae),ae++):(i=a,0===fe&&be(Yt));i!==a;)n.push(i),U.test(t.charAt(ae))?(i=t.charAt(ae),ae++):(i=a,0===fe&&be(Yt));93===t.charCodeAt(ae)?(i="]",ae++):(i=a,0===fe&&be(te)),i!==a?(ue=e,e=function(t){return new Description(t.flat().join(""),Description.types.MULTILINE)}(n)):(ae=e,e=a)}else ae=e,e=a;return e}(),e===a&&(e=function(){var e,r,n,i,o,s;e=ae,t.substr(ae,2)===V?(r=V,ae+=2):(r=a,0===fe&&be(ee));r===a&&(35===t.charCodeAt(ae)?(r="#",ae++):(r=a,0===fe&&be(re)));if(r!==a){for(n=[],i=ae,o=ae,fe++,s=Fe(),fe--,s===a?o=void 0:(ae=o,o=a),o!==a?(t.length>ae?(s=t.charAt(ae),ae++):(s=a,0===fe&&be(Xt)),s!==a?i=o=[o,s]:(ae=i,i=a)):(ae=i,i=a);i!==a;)n.push(i),i=ae,o=ae,fe++,s=Fe(),fe--,s===a?o=void 0:(ae=o,o=a),o!==a?(t.length>ae?(s=t.charAt(ae),ae++):(s=a,0===fe&&be(Xt)),s!==a?i=o=[o,s]:(ae=i,i=a)):(ae=i,i=a);ue=e,e=function(t){return new Description(t.flat().join(""),Description.types.INLINE)}(n)}else ae=e,e=a;return e}()),fe--,e===a&&0===fe&&be(Wt),e}function Fe(){var e;return K.test(t.charAt(ae))?(e=t.charAt(ae),ae++):(e=a,0===fe&&be(ne)),e}function Pe(){var e;return fe++,W.test(t.charAt(ae))?(e=t.charAt(ae),ae++):(e=a,0===fe&&be(oe)),fe--,e===a&&0===fe&&be(ie),e}function Ie(){var t,e;for(t=[],e=Pe();e!==a;)t.push(e),e=Pe();return t}function Je(){var t,e;for(fe++,t=[],(e=Pe())===a&&(e=De());e!==a;)t.push(e),(e=Pe())===a&&(e=De());return fe--,e=a,0===fe&&be(se),t}if((n=c())!==a&&ae===t.length)return n;throw n!==a&&ae<t.length&&be({type:"end"}),i=he,o=ce<t.length?t.charAt(ce):null,s=ce<t.length?we(ce,ce+1):we(ce,ce),new Pt(Pt.buildMessage(i,o),i,o,s)}!function(t,e){function r(){this.constructor=t}r.prototype=e.prototype,t.prototype=new r}(Pt,Error),Pt.prototype.format=function(t){var e="Error: "+this.message;if(this.location){var r,n=null;for(r=0;r<t.length;r++)if(t[r].source===this.location.source){n=t[r].text.split(/\r\n|\n|\r/g);break}var i=this.location.start,o=this.location.source+":"+i.line+":"+i.column;if(n){var s=this.location.end,a=It("",i.line.toString().length," "),u=n[i.line-1],l=(i.line===s.line?s.column:u.length+1)-i.column||1;e+="\n --\x3e "+o+"\n"+a+" |\n"+i.line+" | "+u+"\n"+a+" | "+It("",i.column-1," ")+It("",l,"^")}else e+="\n at "+o}return e},Pt.buildMessage=function(t,e){var r={literal:function(t){return'"'+i(t.text)+'"'},class:function(t){var e=t.parts.map((function(t){return Array.isArray(t)?o(t[0])+"-"+o(t[1]):o(t)}));return"["+(t.inverted?"^":"")+e.join("")+"]"},any:function(){return"any character"},end:function(){return"end of input"},other:function(t){return t.description}};function n(t){return t.charCodeAt(0).toString(16).toUpperCase()}function i(t){return t.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,(function(t){return"\\x0"+n(t)})).replace(/[\x10-\x1F\x7F-\x9F]/g,(function(t){return"\\x"+n(t)}))}function o(t){return t.replace(/\\/g,"\\\\").replace(/\]/g,"\\]").replace(/\^/g,"\\^").replace(/-/g,"\\-").replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,(function(t){return"\\x0"+n(t)})).replace(/[\x10-\x1F\x7F-\x9F]/g,(function(t){return"\\x"+n(t)}))}function s(t){return r[t.type](t)}return"Expected "+function(t){var e,r,n=t.map(s);if(n.sort(),n.length>0){for(e=1,r=1;e<n.length;e++)n[e-1]!==n[e]&&(n[r]=n[e],r++);n.length=r}switch(n.length){case 1:return n[0];case 2:return n[0]+" or "+n[1];default:return n.slice(0,-1).join(", ")+", or "+n[n.length-1]}}(t)+" but "+function(t){return t?'"'+i(t)+'"':"end of input"}(e)+" found."};class Parser{static parse(t){if(!t)throw new RequiredArgumentError("notation");if("string"!=typeof t)throw new TypeError("Notation must be a string");return Jt(t)}}const jt=Object.freeze({BASE_64:1,JSON:0,OBJECT:2}),qt=Symbol("notation"),Gt=Symbol("maxTotal"),Vt=Symbol("minTotal"),kt=Symbol("expressions"),_t=Symbol("roll-method"),Bt=Symbol("rolls"),zt=Symbol("set-rolls"),Lt=Symbol("total"),Ut=t=>((t,e=0)=>parseFloat(parseFloat(`${t}`).toFixed(e||0)))(t.calculationValue,2);class DiceRoll{constructor(t){if(!t)throw new RequiredArgumentError("notation");if(this[kt]=[],t instanceof Object&&!Array.isArray(t)){if(!t.notation)throw new RequiredArgumentError("notation");if("string"!=typeof t.notation)throw new NotationError(t.notation);t.rolls&&this[zt](t.rolls),this[qt]=t.notation,this[kt]=Parser.parse(this.notation),this.hasRolls()||this.roll()}else{if("string"!=typeof t)throw new NotationError(t);this[qt]=t,this[kt]=Parser.parse(this.notation),this.roll()}}get averageTotal(){return(this.maxTotal+this.minTotal)/2}get maxTotal(){if(!this.hasExpressions())return 0;if(!this[Gt]){const t=this[_t](L.max);this[Gt]=Ut(t)}return this[Gt]}get minTotal(){if(!this.hasExpressions())return 0;if(!this[Vt]){const t=this[_t](L.min);this[Vt]=Ut(t)}return this[Vt]}get notation(){return this[qt]}get output(){let t=`${this.notation}: `;return this.hasRolls()?t+=`${this[Bt]} = ${this.total}`:t+="No dice rolled",t}get rolls(){return this[Bt]?this[Bt].results:[]}get total(){return!this[Lt]&&this.hasRolls()&&(this[Lt]=Ut(this[Bt])),this[Lt]||0}export(t=jt.JSON){switch(t){case jt.BASE_64:return btoa(this.export(jt.JSON));case jt.JSON:return JSON.stringify(this);case jt.OBJECT:return JSON.parse(this.export(jt.JSON));default:throw new TypeError(`Invalid export format "${t}"`)}}hasExpressions(){return this[kt]&&this[kt].length>0}hasRolls(){return this.hasExpressions()&&this.rolls.length>0}roll(){return this[Lt]=0,this[Bt]=this[_t](),this.rolls}toJSON(){const{averageTotal:t,maxTotal:e,minTotal:r,notation:n,output:i,rolls:o,total:s}=this;return{averageTotal:t,maxTotal:e,minTotal:r,notation:n,output:i,rolls:o,total:s,type:"dice-roll"}}toString(){return this.output}static import(t){if(t){if($t(t))return DiceRoll.import(JSON.parse(t));if(Ot(t))return DiceRoll.import(atob(t));if("object"==typeof t)return new DiceRoll(t);throw new DataFormatError(t)}throw new RequiredArgumentError("data")}[_t](t){let e;t&&(e=U.engine,U.engine=t);const r=new ResultGroup(this[kt].map((t=>t instanceof StandardDice||t instanceof RollGroup?t.roll():t)).filter((t=>!!t||0===t)));return t&&(U.engine=e),r}[zt](t){if(t instanceof ResultGroup)this[Bt]=t;else if(t instanceof RollResults)this[Bt]=new ResultGroup([t]);else{if(!Array.isArray(t))throw new TypeError("Rolls must be a valid result object, or an array");this[Bt]=new ResultGroup(t.map((t=>{if(t instanceof ResultGroup||t instanceof RollResults)return t;if(Array.isArray(t))return new RollResults(t);if("object"==typeof t){if(Array.isArray(t.results))return new ResultGroup(t.results,t.modifiers||[],t.isRollGroup||!1,"boolean"!=typeof t.useInTotal||t.useInTotal);if(Array.isArray(t.rolls))return new RollResults(t.rolls)}return t})))}}}const Kt=Symbol("log");class DiceRoller{constructor(t){this[Kt]=[],t&&this.import(t)}get log(){return this[Kt]||[]}get output(){return this.log.join("; ")}get total(){return this.log.reduce(((t,e)=>t+e.total),0)}clearLog(){this[Kt].length=0}export(t=jt.JSON){switch(t){case jt.BASE_64:return btoa(this.export(jt.JSON));case jt.JSON:return JSON.stringify(this);case jt.OBJECT:return JSON.parse(this.export(jt.JSON));default:throw new TypeError(`Invalid export format "${t}"`)}}import(t){if(t){if($t(t))return this.import(JSON.parse(t));if(Ot(t))return this.import(atob(t));if("object"==typeof t){let e=t.log||null;if(!t.log&&Array.isArray(t)&&t.length&&(e=t),e&&Array.isArray(e))e.forEach((t=>{this[Kt].push(DiceRoll.import(t))}));else if(e)throw new TypeError("log must be an array");return this.log}throw new DataFormatError(t)}throw new RequiredArgumentError("data")}roll(...t){const e=t.filter(Boolean);if(0===e.length)throw new RequiredArgumentError("notations");const r=e.map((t=>{const e=new DiceRoll(t);return this[Kt].push(e),e}));return r.length>1?r:r[0]}toJSON(){const{log:t,output:e,total:r}=this;return{log:t,output:e,total:r,type:"dice-roller"}}toString(){return this.output}static import(t){const e=new DiceRoller;return e.import(t),e}}export{ComparePoint,gt as Dice,DiceRoll,DiceRoller,e as Exceptions,Ct as Modifiers,K as NumberGenerator,Parser,Nt as Results,RollGroup,jt as exportFormats};
